import os, requests, time, subprocess, xml.etree.ElementTree as ET
from dotenv import load_dotenv
from datetime import datetime
import requests,json, random, time

load_dotenv('/root/agent_system/.env')
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
NEYNAR_API_KEY = os.getenv("NEYNAR_API_KEY")
SIGNER_UUID = os.getenv("SIGNER_UUID")
DISCORD_URL = "https://discord.com/api/webhooks/1469793300075512090/dCdj2wFQuDrw597CmZ_nTcSzlleVxTL6zHkzYhXYfia3oneI0Ua0mrfxI0y5K7v14bUW"
GITHUB_REPO = "https://github.com/Xanoutas/AI-Bounty-Solutions.git"
KEYWORDS = ["python", "automation", "web3", "solidity", "gho", "base", "ethereum","gho", "base", "ethereum", "ai agents", "react", "smart contracts", "typescript","electrical","mechanical","industrial","automation","PLC"]
LAST_HEARTBEAT = 0
LAST_KEYWORD_UPDATE = ""

def send_to_discord(payload):
    """Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¼Î­ÏƒÏ‰ System Curl Î³Î¹Î± Î¼Î­Î³Î¹ÏƒÏ„Î· Î±Î¾Î¹Î¿Ï€Î¹ÏƒÏ„Î¯Î±"""
    json_payload = json.dumps(payload)
    # Î§ÏÎ®ÏƒÎ· single quotes Î³Î¹Î± Ï„Î¿ shell command
    command = f"curl -s -X POST -H 'Content-Type: application/json' -d '{json_payload}' {DISCORD_URL} > /dev/null"
    os.system(command)

def get_financial_status():
    # 1. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Data Farming (SQLite)
    try:
        conn = sqlite3.connect("/root/agent_system/ioannina_homes.db")
        count = conn.execute("SELECT COUNT(*) FROM listings").fetchone()[0]
        conn.close()
    except: count = 0

    # 2. Î•ÎºÏ„Î¯Î¼Î·ÏƒÎ· ÎºÎµÏÎ´ÏÎ½ (Î ÏÎ¿ÏƒÎ¿Î¼Î¿Î¯Ï‰ÏƒÎ· Î²Î¬ÏƒÎµÎ¹ ÏƒÎµÎ½Î±ÏÎ¯Ï‰Î½)
    # Î‘Ï€Î±Î¹ÏƒÎ¹ÏŒÎ´Î¿Î¾Î¿: $400/mo -> ~$13/day
    # ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ: $1,400/mo -> ~$46/day
    daily_est = 46 if count > 0 else 13 

    # 3. Hardware Status (Simulated via Ping Î® Tailscale API)
    # Î•Î´Ï Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î¼Îµ Î½Î± Î²Î¬Î»Î¿Ï…Î¼Îµ Î­Î»ÎµÎ³Ï‡Î¿ Î±Î½ Ï„Î¿ 5G ÏƒÏ„Î± Î ÎµÏƒÏ„Î¬ ÎµÎ¯Î½Î±Î¹ UP
    
    status_msg = (
        f"ğŸ’° **Financial Dashboard**\n"
        f"ğŸ“Š **Data Assets:** {count} listings collected for Ocean\n"
        f"ğŸš€ **Est. Daily Revenue (Base):** ${daily_est}\n"
        f"ğŸ–¥ï¸ **Active Rigs:** EPYC (DE) âœ… | Ryzen 9 (GR) â³ | 3x5070 (Pesta) â³\n"
        f"ğŸ“ˆ **Monthly Goal:** $1,400"
    )
    return status_msg

def send_dashboard():
    dashboard = get_financial_status()
    payload = {
        "embeds": [{
            "title": "ğŸ’ System Revenue & Health Report",
            "description": dashboard,
            "color": 0x00ff00, # Î ÏÎ¬ÏƒÎ¹Î½Î¿ Î³Î¹Î± Ï„Î¿ "Ï‡ÏÎ®Î¼Î±"
            "footer": {"text": "Updated via EPYC Germany Agent"}
        }]
    }
    send_to_discord(payload)

def check_all_platforms():
    """Î•Î½Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ check Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼ÎµÏ‚ Î¼Îµ 'Î±Î½Î¿Î¹Ï‡Ï„ÏŒ' Ï†Î¯Î»Ï„ÏÎ¿"""
    
    # 1. BOUNTYCASTER
   # try:
    #    r = requests.get("https://api.bountycaster.xyz/all-open-bounties", timeout=20)
     #   if r.status_code == 200:
      #      for b in r.json()[:10]:
       #         title = b.get('title', b.get('content', 'No Title'))
        #        link = f"https://www.bountycaster.xyz/bounty/{b.get('id')}"
         #       process_and_notify("Bountycaster", title, link)
    #except Exception as e: print(f"Bountycaster Error: {e}")

    # 2. OCEAN PROTOCOL (GitHub Issues)
    try:
        r = requests.get("https://api.github.com/repos/oceanprotocol/ocean/issues?labels=bounty", timeout=20)
        if r.status_code == 200:
            for issue in r.json()[:5]:
                process_and_notify("Ocean", issue['title'], issue['html_url'])
    except Exception as e: print(f"Ocean Error: {e}")

    # 3. DEWORK (API Endpoint - Simulation)
    try:
        # Î•Î´Ï Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ endpoint Ï€Î¿Ï… Î²ÏÎ®ÎºÎ±Î¼Îµ ÏŒÏ„Î¹ Î´Î¿Ï…Î»ÎµÏÎµÎ¹ ÏƒÏ„Î¿Î½ EPYC
        r = requests.get("https://api.dework.xyz/v1/bounties/trending", timeout=20)
        if r.status_code == 200:
            for d in r.json()[:5]:
                process_and_notify("Dework", d['title'], f"https://app.dework.xyz/bounty/{d['id']}")
    except: pass

def process_and_notify(platform, title, link):
    """ÎšÏÎ¯Î½ÎµÎ¹ Î±Î½ Î¸Î± Î²Î¬Î»ÎµÎ¹ â­ Î® ğŸ‘ï¸ ÎºÎ±Î¹ ÏƒÏ„Î­Î»Î½ÎµÎ¹ Discord"""
    has_keyword = any(k.lower() in title.lower() for k in KEYWORDS)
    icon = "â­" if has_keyword else "ğŸ‘ï¸"
    color = 0xf1c40f if has_keyword else 0x95a5a6
    
    # Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Discord
    payload = {
        "embeds": [{
            "description": f"{icon} **[{platform}]** {title}\n[Link]({link})",
            "color": color
        }]
    }
    send_to_discord(payload)

def update_keywords_daily():
    global KEYWORDS, LAST_KEYWORD_UPDATE
    current_day = datetime.now().strftime("%Y-%m-%d")
    current_hour = datetime.now().hour
    
    # Î— Î²Î±ÏƒÎ¹ÎºÎ® ÏƒÎ¿Ï… Î»Î¯ÏƒÏ„Î± Ï€Î¿Ï… Î´ÎµÎ½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï€Î¿Ï„Î­
    BASE_KEYWORDS = ["python", "automation", "web3", "solidity", "gho", "base", "ethereum","JAVASCRIPT", "electrical","mechanical","idustrial","CAD", "PLC"]
    
    if current_hour == 8 and LAST_KEYWORD_UPDATE != current_day:
        prompt = f"Based on Web3 trends, suggest 30 trending bounty keywords. Current: {KEYWORDS}. Return ONLY comma separated keywords."
        res = call_openai(prompt)
        if res:
            ai_keys = [k.strip().lower() for k in res.split(",")]
            # Î•Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Base + AI Keys (Ï‡Ï‰ÏÎ¯Ï‚ Î´Î¹Ï€Î»ÏŒÏ„Ï…Ï€Î±)
            KEYWORDS = list(set(BASE_KEYWORDS + ai_keys))
            LAST_KEYWORD_UPDATE = current_day
            
            # Î— Î±Î½Î±Ï†Î¿ÏÎ¬ Ï€Î¿Ï… Î¶Î®Ï„Î·ÏƒÎµÏ‚ ÏƒÏ„Î¿ Discord
            report_msg = f"**Daily Trend Analysis Complete**\n\n"
            report_msg += f"âœ… **Base Keywords Kept:** {', '.join(BASE_KEYWORDS)}\n"
            report_msg += f"ğŸ”¥ **AI Trending Added:** {res}\n\n"
            report_msg += f"ğŸ¯ **Total Active Keywords:** {len(KEYWORDS)}"
            notify_discord("ğŸ“ˆ 08:00 Keyword Report", report_msg)

def notify_discord(title, status, url="https://github.com/Xanoutas", is_heartbeat=False):
    color = 3447003 if is_heartbeat else 3066993
    try: requests.post(DISCORD_URL, json={"embeds": [{"title": title, "description": status, "url": url, "color": color}]}, timeout=10)
    except: pass

def check_ocean_protocol():
    """Scrapes Ocean Protocol GitHub Issues & Grant channels"""
    try:
        # Check Ocean Protocol Main Repo Issues for Bounties
        url = "https://api.github.com/repos/oceanprotocol/ocean/issues?labels=bounty,help%20wanted"
        r = requests.get(url, timeout=20)
        if r.status_code == 200:
            for issue in r.json():
                process_task("Ocean Protocol", issue['title'], issue.get('body', ''), issue['html_url'])
        
        # Check Ocean Shipyard (Grants/Market Tasks)
        # Î•Î´Ï Ï€ÏÎ¿ÏƒÎ¿Î¼Î¿Î¹ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ check ÏƒÏ„Î¿ shipyard portal
        r_ship = requests.get("https://oceanprotocol.com/shipyard", timeout=20)
        if "Ocean Shipyard" in r_ship.text:
             # Logic to detect new grant rounds if the API is restricted
             pass
    except: pass

def check_ocean_market():
    """Monitors Ocean Market for data-related challenges"""
    try:
        # API call to Ocean subgraph or market indexer (simplified)
        r = requests.get("https://v4.provider.mainnet.oceanprotocol.com/api/v1/services", timeout=20)
        # Î‘Î½ Î²ÏÎ¿ÏÎ¼Îµ Î½Î­Î± datasets Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ AI algorithms (Compute-to-Data)
        if r.status_code == 200:
            pass # Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· tasks Î³Î¹Î± AI model training
    except: pass

def apply_via_farcaster(parent_hash, title):
    if not SIGNER_UUID or not parent_hash: return
    url = "https://api.neynar.com/v2/farcaster/cast"
    msg = f"EPYC Agent detected bounty: {title}. Working on a solution now! ğŸš€"
    headers = {"api_key": NEYNAR_API_KEY, "content-type": "application/json"}
    try: requests.post(url, json={"signer_uuid": SIGNER_UUID, "text": msg, "parent_hash": parent_hash}, headers=headers, timeout=10)
    except: pass

def call_openai(prompt):
    if not OPENAI_API_KEY: return None
    headers = {"Authorization": f"Bearer {OPENAI_API_KEY}", "Content-Type": "application/json"}
    payload = {"model": "gpt-4o", "messages": [{"role": "user", "content": prompt}]}
    try:
        r = requests.post("https://api.openai.com/v1/chat/completions", headers=headers, json=payload, timeout=60)
        return r.json()['choices'][0]['message']['content'].strip()
    except: return None

def auditor_solve(title, description):
    attempt, feedback = 1, ""
    while attempt <= 3:
        prompt = f"Task: {title}\nDesc: {description}\n{feedback}\nWrite clean Python code. Start with 'PASSED' if correct."
        res = call_openai(prompt)
        if res and "PASSED" in res.upper():
            return res.upper().replace("PASSED", "").replace("```PYTHON", "").replace("```", "").strip()
        feedback = f"Your previous code failed. Fix it: {res}"
        attempt += 1
    return None

def epyc_decision_logic(task_title):
    task_lower = task_title.lower()
    if any(x in task_lower for x in ["gpu", "ai", "cuda"]): return "RTX 5070 (Pesta)"
    if any(x in task_lower for x in ["heavy", "compile"]): return "Ryzen 9 5950X"
    return "EPYC (Local)"

def auto_submit_to_github(title, code):
    try:
        subprocess.run(["find", ".", "-name", "__pycache__", "-delete"], cwd="/root/agent_system")
        fname = f"sol_{int(time.time())}.py"
        with open(f"/root/agent_system/{fname}", 'w') as f: f.write(code)
        subprocess.run(["git", "add", "."], cwd="/root/agent_system")
        subprocess.run(["git", "commit", "-m", f"Auto-Solution: {title}"], cwd="/root/agent_system")
        subprocess.run(["git", "push", GITHUB_REPO, "main", "--force"], cwd="/root/agent_system")
        return True
    except: return False

def process_task(platform, title, description, link, cast_hash=None):
    if any(k in title.lower() for k in KEYWORDS):
        if platform == "Bountycaster" and cast_hash:
            apply_via_farcaster(cast_hash, title)
        node = epyc_decision_logic(title)
        code = auditor_solve(title, description)
        if code and auto_submit_to_github(title, code):
            notify_discord(f"âœ… {platform} Solved", f"Task: {title}\nNode: {node}", link)

#def check_bountycaster():
 #   try:
  #      r = requests.get("https://api.bountycaster.xyz/all-open-bounties", timeout=20)
   #     for b in r.json()[:15]:
    #        process_task("Bountycaster", b.get('title', ''), b.get('content', ''), f"https://www.bountycaster.xyz/bounty/{b.get('id')}", b.get('hash'))
    #except: pass

def check_onlydust():
    q = "{ projects { name githubRepo { issues(status: OPEN) { title htmlUrl body } } } }"
    try:
        r = requests.post("https://api.onlydust.xyz/graphql", json={'query': q}, timeout=20)
        for p in r.json()['data']['projects']:
            for i in p['githubRepo']['issues']:
                process_task("OnlyDust", i['title'], i.get('body', ''), i['htmlUrl'])
    except: pass

def check_gitcoin():
    try:
        r = requests.get("https://indexer-grants-stack.gitcoin.co/data/rounds.json", timeout=20)
        if r.status_code == 200:
            for rd in r.json()[:10]:
                process_task("Gitcoin", rd.get('roundName', ''), "", "https://explorer.gitcoin.co")
    except: pass

def check_dework():
    try:
        r = requests.get("https://api.dework.xyz/v1/bounties/rss", timeout=20)
        if r.status_code == 200:
            root = ET.fromstring(r.content)
            for item in root.findall('./channel/item')[:10]:
                process_task("Dework", item.find('title').text, "", item.find('link').text)
    except: pass

def check_ethglobal():
    try:
        r = requests.get("https://ethglobal.com/api/events/active", timeout=20)
        if r.status_code == 200:
            for event in r.json():
                process_task("ETHGlobal", event.get('title', ''), "Hackathon Task", f"https://ethglobal.com/events/{event.get('id')}")
    except: pass

if __name__ == "__main__":
    notify_discord("ğŸš€ Hunter V6.0 Online", "All scrapers active. Monitoring Web3 Bounties.")
    while True:
        if time.time() - LAST_HEARTBEAT > 21600:
            notify_discord("ğŸ’“ Heartbeat", "System operational. Scanning...", is_heartbeat=True)
            LAST_HEARTBEAT = time.time()
     #   check_bountycaster()
        check_onlydust()
        check_gitcoin()
        check_dework()
        check_ethglobal()
        check_ocean_protocol()
        check_ocean_market()
        check_all_platforms()
        wait_time = 900 + random.randint(1, 180) # 15-18 Î»ÎµÏ€Ï„Î¬
        time.sleep(wait_time)
